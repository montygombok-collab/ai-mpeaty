<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHAHRAZAD ELECTRIC | نظام إدارة المبيعات المتقدم</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        /* Custom styles for SHAHRAZAD ELECTRIC identity */
        body { font-family: 'Cairo', sans-serif; background-color: #f4f7fa; }
        .text-shahrazad { color: #004d99; } 
        .bg-shahrazad { background-color: #004d99; }
        .gradient-bg { background: linear-gradient(135deg, #004d99 0%, #002d5b 100%); }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08); transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12); }
        #chat-body { height: 300px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .chat-message-user { background-color: #dbeafe; border-bottom-right-radius: 0; }
        .chat-message-ai { background-color: #e0f2f1; color: #004d99; border-bottom-left-radius: 0; }
        
        /* Print Styles */
        @media print {
            body > :not(#content-area) { display: none !important; }
            #content-area { margin: 0; padding: 20px; width: 100%; height: auto !important; }
            #global-alert { display: none !important; }
            .print-hidden { display: none !important; }
            .invoice-print { border: 2px solid #000; padding: 20px; margin: 0; }
            .invoice-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
            .invoice-items { width: 100%; border-collapse: collapse; margin: 20px 0; }
            .invoice-items th, .invoice-items td { border: 1px solid #000; padding: 8px; text-align: center; }
            .invoice-total { font-size: 18px; font-weight: bold; text-align: left; margin-top: 20px; }
        }

        /* Barcode scanner styles */
        #barcode-scanner { transition: all 0.3s ease; }
        #barcode-scanner.active { border: 2px solid #004d99; box-shadow: 0 0 10px rgba(0, 77, 153, 0.5); }
        #barcode-video { border-radius: 8px; }
    </style>
</head>
<body>

    <script type="module">
        // ====================================================================
        // Firebase Configuration and Imports
        // ====================================================================
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBtc-pniRx5Mda5UW_kNqS0Zyi8zcKvdlU",
            authDomain: "shahrazad-electric.firebaseapp.com",
            projectId: "shahrazad-electric",
            storageBucket: "shahrazad-electric.firebasestorage.app",
            messagingSenderId: "582314926345",
            appId: "1:582314926345:web:39c2979beadd8b47a133d8",
            measurementId: "G-3RH0BKKW16"
        };

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ====================================================================
        // Session Management & Authentication Check
        // ====================================================================
        
        function checkAuthentication() {
            const userSession = localStorage.getItem('shahrazad_user');
            if (!userSession) {
                window.location.href = 'login.html';
                return null;
            }
            
            const user = JSON.parse(userSession);
            const loginTime = new Date(user.loginTime);
            const now = new Date();
            const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
            
            if (hoursDiff >= 24) {
                localStorage.removeItem('shahrazad_user');
                window.location.href = 'login.html';
                return null;
            }
            
            return user;
        }

        const currentUser = checkAuthentication();
        if (!currentUser) {
            throw new Error('User not authenticated');
        }
        
        // ====================================================================
        // Global State (App)
        // ====================================================================
        
        window.App = {
            db,
            auth,
            userId: null,
            userRole: currentUser.role,
            userSession: currentUser,
            view: 'dashboard',
            data: { 
                products: [], 
                customers: [], 
                invoices: [], 
                users: [], 
                alerts: [], 
                warehouses: [] 
            },
            barcodeScanner: null,
            
            getCollectionPath(collectionName) {
                return `artifacts/shahrazad-electric/public/data/${collectionName}`;
            },
        };

        // ====================================================================
        // Authentication and Initialization
        // ====================================================================
        
        async function authenticateUser() {
            try {
                await signInAnonymously(App.auth);
            } catch (error) {
                console.error("Firebase authentication error:", error);
                App.view = 'auth_error';
                render();
            }
        }

        function setupAuthStateListener() {
            onAuthStateChanged(App.auth, async (user) => {
                if (user) {
                    App.userId = user.uid;
                    const userDocRef = doc(App.db, App.getCollectionPath('users'), user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        App.userRole = userDoc.data().role || 'staff';
                    } else {
                        App.userRole = 'staff'; 
                        await setDoc(userDocRef, { 
                            uid: user.uid, 
                            role: App.userRole, 
                            username: App.userSession.username,
                            name: App.userSession.name,
                            createdAt: new Date().toISOString() 
                        }, { merge: true });
                    }

                    setupFirestoreListeners();
                    App.view = 'dashboard'; 
                } else {
                    await signInAnonymously(App.auth);
                }
                render();
            });
        }
        
        window.handleLogout = () => {
            localStorage.removeItem('shahrazad_user');
            signOut(App.auth).then(async () => { 
                alertUser("تم تسجيل الخروج بنجاح.", "success"); 
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            }).catch(console.error);
        };

        // ====================================================================
        // Firestore Data Listeners
        // ====================================================================

        function setupFirestoreListeners() {
            if (!App.userId) return;

            // Products
            onSnapshot(collection(App.db, App.getCollectionPath('products')), (snapshot) => {
                App.data.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                checkLowStockAlerts();
                if (['products', 'dashboard', 'alerts', 'invoices'].includes(App.view)) render(); 
            }, console.error);

            // Customers
            onSnapshot(collection(App.db, App.getCollectionPath('customers')), (snapshot) => {
                App.data.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['customers', 'invoices', 'dashboard'].includes(App.view)) render();
            }, console.error);
            
            // Invoices
            onSnapshot(collection(App.db, App.getCollectionPath('invoices')), (snapshot) => {
                App.data.invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['dashboard', 'invoices'].includes(App.view)) render();
            }, console.error);
            
            // Users
            onSnapshot(collection(App.db, App.getCollectionPath('users')), (snapshot) => {
                App.data.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (App.view === 'user_settings') render();
            }, console.error);

            // Warehouses
            onSnapshot(collection(App.db, App.getCollectionPath('warehouses')), (snapshot) => {
                App.data.warehouses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['products', 'warehouses'].includes(App.view)) render();
            }, console.error);
        }
        
        // ====================================================================
        // Invoice System - المحلول الجديد
        // ====================================================================

        window.handleInvoiceSubmit = async (e) => {
            e.preventDefault();
            if (!App.userId) return;

            const customerId = document.getElementById('invoice-customer').value;
            const customerName = document.getElementById('invoice-customer').options[document.getElementById('invoice-customer').selectedIndex].text;
            const itemRows = document.querySelectorAll('#invoice-items-container > div');
            
            let items = [];
            let total = 0;
            let hasError = false;

            // التحقق من الأصناف والكميات
            itemRows.forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const quantityInput = row.querySelector('.invoice-quantity');
                const priceInput = row.querySelector('.invoice-price');
                
                const productId = productSelect.value;
                const quantity = parseInt(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;

                if (productId && quantity > 0) {
                    const product = App.data.products.find(p => p.id === productId);
                    if (!product) {
                        alertUser("خطأ: الصنف المحدد غير موجود", "error");
                        hasError = true;
                        return;
                    }

                    if (product.stock < quantity) {
                        alertUser(`خطأ: كمية "${product.name}" (${quantity}) تتجاوز المخزون (${product.stock}).`, 'error');
                        hasError = true;
                        return;
                    }
                    
                    const subtotal = quantity * price;
                    items.push({ 
                        productId, 
                        productName: product.name,
                        quantity, 
                        price, 
                        subtotal 
                    });
                    total += subtotal;
                }
            });

            if (hasError || items.length === 0) {
                if (items.length === 0 && !hasError) {
                    alertUser('الرجاء إضافة صنف واحد على الأقل للفاتورة.', 'error');
                }
                return;
            }
            
            // حالة التحميل
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalContent = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري معالجة الفاتورة...';
            lucide.createIcons();

            try {
                // 1. تحديث المخزون
                const batch = writeBatch(db);
                items.forEach(item => {
                    const product = App.data.products.find(p => p.id === item.productId);
                    if (product) {
                        const productRef = doc(db, App.getCollectionPath('products'), item.productId);
                        batch.update(productRef, { 
                            stock: product.stock - item.quantity 
                        });
                    }
                });
                await batch.commit();

                // 2. إنشاء الفاتورة
                const invoiceData = {
                    invoiceId: `INV-${Date.now()}`,
                    customerId: customerId,
                    customerName: customerName,
                    items: items,
                    total: total,
                    date: new Date().toISOString(),
                    processedBy: App.userId,
                    status: 'completed'
                };

                const invoiceRef = await addDoc(collection(db, App.getCollectionPath('invoices')), invoiceData);
                
                // 3. تحديث بيانات العميل إذا لم يكن ضيف
                if (customerId !== 'guest') {
                    const customerRef = doc(db, App.getCollectionPath('customers'), customerId);
                    const customerDoc = await getDoc(customerRef);
                    
                    if (customerDoc.exists()) {
                        const customerData = customerDoc.data();
                        const newTotalSpent = (customerData.totalSpent || 0) + total;
                        const newTotalInvoices = (customerData.totalInvoices || 0) + 1;
                        
                        await updateDoc(customerRef, {
                            totalSpent: newTotalSpent,
                            totalInvoices: newTotalInvoices,
                            isDistinguished: newTotalSpent > 5000,
                            lastPurchase: new Date().toISOString()
                        });
                    }
                }

                // نجاح - إظهار رسالة النجاح
                alertUser(`تم إنشاء الفاتورة بنجاح! الرقم: ${invoiceData.invoiceId} - الإجمالي: ${total.toFixed(2)} ر.ق`, 'success');
                
                // إعادة تعيين النموذج
                document.getElementById('new-invoice-form').reset();
                document.getElementById('invoice-items-container').innerHTML = `
                    <div class="flex space-x-2 space-x-reverse items-center print:grid print:grid-cols-5 print:gap-2 print:border-b print:pb-1">
                        <select name="product-id" class="flex-1 p-2 border rounded-lg product-select print:border-none print:p-1 print:col-span-2" required onchange="calculateInvoiceTotal()">
                            <option value="">اختر صنف...</option>
                            ${App.data.products.map(p => 
                                `<option value="${p.id}" data-price="${p.price}" data-stock="${p.stock}">${p.name} (مخزون: ${p.stock})</option>`
                            ).join('')}
                        </select>
                        <input type="number" name="quantity" placeholder="الكمية" min="1" value="1" class="w-20 p-2 border rounded-lg text-center invoice-quantity print:border-none print:p-1 print:w-auto" required onchange="calculateInvoiceTotal()">
                        <input type="text" name="price" placeholder="السعر" class="w-24 p-2 border rounded-lg text-center invoice-price bg-gray-200 print:border-none print:p-1 print:w-auto" readonly>
                        <button type="button" onclick="removeInvoiceItem(this)" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 print:hidden"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                `;
                calculateInvoiceTotal();
                lucide.createIcons();

                // إظهار خيارات متابعة
                submitButton.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5 ml-2 inline"></i> تمت العملية بنجاح';
                
                // إضافة أزرار إضافية
                const actionDiv = document.createElement('div');
                actionDiv.className = 'flex gap-4 mt-4 print-hidden';
                actionDiv.innerHTML = `
                    <button onclick="printInvoice('${invoiceRef.id}')" class="flex-1 py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition flex items-center justify-center">
                        <i data-lucide="printer" class="w-5 h-5 ml-2"></i> طباعة الفاتورة
                    </button>
                    <button onclick="navigateTo('invoices')" class="flex-1 py-3 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 transition flex items-center justify-center">
                        <i data-lucide="plus" class="w-5 h-5 ml-2"></i> فاتورة جديدة
                    </button>
                `;
                e.target.appendChild(actionDiv);
                lucide.createIcons();

            } catch (error) {
                console.error("Error creating invoice:", error);
                alertUser(`فشل إنشاء الفاتورة: ${error.message}`, 'error');
                submitButton.innerHTML = originalContent;
                submitButton.disabled = false;
            }
        };

        // دالة الطباعة المحسنة
        window.printInvoice = async (invoiceId) => {
            const invoice = App.data.invoices.find(inv => inv.id === invoiceId);
            if (!invoice) {
                alertUser("لم يتم العثور على بيانات الفاتورة", "error");
                return;
            }

            // إنشاء محتوى الطباعة
            const printContent = `
                <div class="invoice-print">
                    <div class="invoice-header">
                        <h1 class="text-3xl font-bold">فاتورة SHAHRAZAD ELECTRIC</h1>
                        <p class="text-lg">رقم الفاتورة: ${invoice.invoiceId}</p>
                        <p class="text-md">التاريخ: ${new Date(invoice.date).toLocaleDateString('ar-EG')}</p>
                    </div>
                    
                    <div class="customer-info">
                        <h3 class="text-xl font-semibold">بيانات العميل:</h3>
                        <p>الاسم: ${invoice.customerName}</p>
                    </div>
                    
                    <table class="invoice-items">
                        <thead>
                            <tr>
                                <th>اسم الصنف</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>المجموع</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr>
                                    <td>${item.productName}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.price.toFixed(2)} ر.ق</td>
                                    <td>${item.subtotal.toFixed(2)} ر.ق</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="invoice-total">
                        <h3>الإجمالي النهائي: ${invoice.total.toFixed(2)} ر.ق</h3>
                    </div>
                    
                    <div class="footer">
                        <p>شكراً لتعاملكم مع SHAHRAZAD ELECTRIC</p>
                        <p>هاتف: 00966123456789 - البريد الإلكتروني: info@shahrazad-electric.com</p>
                    </div>
                </div>
            `;

            // فتح نافذة الطباعة
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>فاتورة ${invoice.invoiceId}</title>
                    <style>
                        body { font-family: 'Cairo', Arial, sans-serif; margin: 20px; }
                        .invoice-print { border: 2px solid #000; padding: 20px; margin: 0; }
                        .invoice-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        .invoice-items { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .invoice-items th, .invoice-items td { border: 1px solid #000; padding: 8px; text-align: center; }
                        .invoice-total { font-size: 18px; font-weight: bold; text-align: left; margin-top: 20px; }
                        .footer { margin-top: 30px; text-align: center; border-top: 1px solid #000; padding-top: 10px; }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(() => window.close(), 1000);
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        // الدوال المساعدة للفواتير
        window.addInvoiceItemRow = () => {
            const container = document.getElementById('invoice-items-container');
            const productsOptions = App.data.products.map(p => 
                `<option value="${p.id}" data-price="${p.price}" data-stock="${p.stock}">${p.name} (مخزون: ${p.stock})</option>`
            ).join('');

            const newRow = document.createElement('div');
            newRow.className = 'flex space-x-2 space-x-reverse items-center print:grid print:grid-cols-5 print:gap-2 print:border-b print:pb-1';
            newRow.innerHTML = `
                <select name="product-id" class="flex-1 p-2 border rounded-lg product-select print:border-none print:p-1 print:col-span-2" required onchange="calculateInvoiceTotal()">
                    <option value="">اختر صنف...</option>
                    ${productsOptions}
                </select>
                <input type="number" name="quantity" placeholder="الكمية" min="1" value="1" class="w-20 p-2 border rounded-lg text-center invoice-quantity print:border-none print:p-1 print:w-auto" required onchange="calculateInvoiceTotal()">
                <input type="text" name="price" placeholder="السعر" class="w-24 p-2 border rounded-lg text-center invoice-price bg-gray-200 print:border-none print:p-1 print:w-auto" readonly>
                <button type="button" onclick="removeInvoiceItem(this)" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 print:hidden"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
            `;
            container.appendChild(newRow);
            lucide.createIcons();
            calculateInvoiceTotal();
        };

        window.removeInvoiceItem = (button) => {
            const row = button.closest('.flex');
            row.remove();
            calculateInvoiceTotal();
        };

        window.calculateInvoiceTotal = () => {
            const rows = document.querySelectorAll('#invoice-items-container > div');
            let grandTotal = 0;

            rows.forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const quantityInput = row.querySelector('.invoice-quantity');
                const priceInput = row.querySelector('.invoice-price');

                const productId = productSelect.value;
                const quantity = parseInt(quantityInput.value) || 0;

                if (productId) {
                    const product = App.data.products.find(p => p.id === productId);
                    if (product) {
                        const price = product.price;
                        priceInput.value = price.toFixed(2);
                        grandTotal += price * quantity;
                    }
                }
            });

            document.getElementById('invoice-total').innerText = grandTotal.toFixed(2);
        };

        // ====================================================================
        // بقية الدوال والوظائف (بدون تغيير)
        // ====================================================================

        function checkLowStockAlerts() {
            const lowStockProducts = App.data.products.filter(p => p.stock <= (p.lowStockThreshold || 10));
            const alertsContainer = document.getElementById('alerts-container');
            const alertsContainerFull = document.getElementById('alerts-container-full');
            
            const alertHTML = lowStockProducts.length > 0
                ? lowStockProducts.map(p => 
                    `<div class="p-3 mb-2 bg-red-100 text-red-700 rounded-lg shadow-sm flex justify-between items-center text-sm border-r-4 border-red-500">
                        <i data-lucide="alert-triangle" class="w-4 h-4 ml-2"></i>
                        <p>الصنف <strong>${p.name}</strong> منخفض. الكمية: <strong>${p.stock}</strong></p>
                    </div>`
                ).join('')
                : `<p class="text-gray-500 text-sm p-4 text-center">لا توجد تنبيهات نقص مخزون حالياً.</p>`;
                
            if (alertsContainer) alertsContainer.innerHTML = alertHTML;
            if (alertsContainerFull) alertsContainerFull.innerHTML = alertHTML;
            lucide.createIcons();
        }

        function alertUser(message, type) {
            const alertBox = document.getElementById('global-alert');
            alertBox.innerText = message;
            alertBox.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-all duration-300 transform ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} translate-y-0 opacity-100`;
            setTimeout(() => {
                alertBox.className += ' -translate-y-20 opacity-0';
            }, 5000);
        }

        window.navigateTo = (viewName) => { App.view = viewName; render(); };

        // ... (بقية الدوال بدون تغيير) ...

        // ====================================================================
        // بدء التطبيق
        // ====================================================================
        
        authenticateUser().then(() => { 
            setupAuthStateListener();
        });

    </script>
    
    <div id="global-alert" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-all duration-300 transform -translate-y-20 opacity-0" role="alert">
    </div>
    
</body>
</html>
