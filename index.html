<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام مبيعات - SHAHRAZAD ELECTRIC</title>
  <!-- External libraries (CDN) -->
  <script type="module">
    // Firebase modular SDK (v9+) imports via CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, doc, setDoc, getDoc, query, where, orderBy, limit, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // Your web app's Firebase configuration (user provided)
    const firebaseConfig = {
      apiKey: "AIzaSyBtc-pniRx5Mda5UW_kNqS0Zyi8zcKvdlU",
      authDomain: "shahrazad-electric.firebaseapp.com",
      projectId: "shahrazad-electric",
      storageBucket: "shahrazad-electric.firebasestorage.app",
      messagingSenderId: "582314926345",
      appId: "1:582314926345:web:39c2979beadd8b47a133d8",
      measurementId: "G-3RH0BKKW16"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    try{ const analytics = getAnalytics(app); } catch(e){ console.warn('Analytics init failed or blocked', e); }
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- Simple state caches used by the UI ---
    const state = {
      currentUser: null,
      branches: [],
      products: [],
      warehouses: [],
      categories: [],
      customers: [],
      invoices: [],
      users: []
    };

    // Utility: Arabic number formatting helper
    const fmt = (v) => new Intl.NumberFormat('ar-EG').format(v);

    // ----------------- Authentication / Role system -----------------
    // We'll store users in a Firestore collection 'users' with a role field (admin, manager, cashier)

    async function signIn(email, password){
      try{
        const cred = await signInWithEmailAndPassword(auth, email, password);
        console.log('Signed in', cred.user.uid);
      } catch(err){ alert('خطأ في تسجيل الدخول: ' + err.message); }
    }

    async function signOutUI(){ await signOut(auth); }

    // Create basic admin account if none exists (caller should run once from admin setup page)
    async function ensureAdminAccount(){
      // This function assumes you have server-side rules to protect user creation in production.
      // For demo only: create a user record in Firestore 'users' collection linked to auth uid.
      alert('لإنشاء حساب مشرف أولي: سجل مستخدم عبر Firebase Console أو نفِّذ registerAdmin() من الكونسول المطور.');
    }

    // When auth state changes, update UI
    onAuthStateChanged(auth, async (user) => {
      state.currentUser = user;
      if(user){
        document.querySelector('#login-panel').classList.add('hidden');
        document.querySelector('#app-panel').classList.remove('hidden');
        document.querySelector('#user-email').textContent = user.email;
        await loadAllData();
        renderDashboard();
      } else {
        document.querySelector('#login-panel').classList.remove('hidden');
        document.querySelector('#app-panel').classList.add('hidden');
      }
    });

    // ----------------- Data loading -----------------
    async function loadAllData(){
      // load collections into state caches
      const colNames = ['branches','products','warehouses','categories','customers','invoices','users'];
      for(const c of colNames){
        const snap = await getDocs(collection(db, c));
        state[c] = snap.docs.map(d=>({id: d.id, ...d.data()}));
      }
      console.log('Data loaded', Object.keys(state).map(k=>[k,state[k].length]));
      renderLowStockAlerts();
    }

    // ----------------- UI rendering -----------------
    function renderDashboard(){
      document.querySelector('#branch-count').textContent = state.branches.length;
      document.querySelector('#product-count').textContent = state.products.length;
      document.querySelector('#warehouse-count').textContent = state.warehouses.length;
      document.querySelector('#customers-count').textContent = state.customers.length;

      // Prepare basic sales stats for chart (simple daily totals from invoices)
      const labels = [];
      const dataPoints = [];
      const last7 = state.invoices.slice(-7);
      for(let inv of last7){ labels.push(new Date(inv.createdAt?.seconds?inv.createdAt.seconds*1000:Date.now()).toLocaleDateString('ar-EG')); dataPoints.push(inv.total || 0); }

      // Draw chart
      drawSalesChart(labels, dataPoints);
    }

    // ----------------- Charts (Chart.js via CDN) -----------------
    function drawSalesChart(labels, data){
      const ctx = document.getElementById('salesChart').getContext('2d');
      if(window._salesChart) window._salesChart.destroy();
      window._salesChart = new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'إجمالي الفواتير', data: data, fill: false }] },
        options: { responsive: true }
      });
    }

    // ----------------- Products / Categories / Warehouses -----------------
    async function addCategory(name){
      const docRef = await addDoc(collection(db,'categories'),{name});
      await loadAllData();
    }
    async function addWarehouse(name){ const docRef = await addDoc(collection(db,'warehouses'),{name}); await loadAllData(); }
    async function addProduct(p){ /* p = {name,sku,categoryId,warehouseId,price,qty,lowStockLimit} */
      await addDoc(collection(db,'products'), {...p}); await loadAllData(); }

    // ----------------- VIP customers (automatic)
    async function ensureVipCustomerByPhone(phone){
      const q = query(collection(db,'customers'), where('phone','==',phone), limit(1));
      const snap = await getDocs(q);
      if(snap.empty){
        const c = { name: 'زبون مميز تلقائي', phone, createdAt: new Date() };
        const ref = await addDoc(collection(db,'customers'), c);
        await loadAllData();
        return {id: ref.id, ...c};
      } else return {id: snap.docs[0].id, ...snap.docs[0].data()};
    }

    // ----------------- Low stock alerts -----------------
    function renderLowStockAlerts(){
      const list = document.querySelector('#low-stock-list');
      list.innerHTML='';
      const low = state.products.filter(p=> (p.qty||0) <= (p.lowStockLimit||5));
      if(low.length===0){ list.innerHTML = '<li>لا توجد أصناف منخفضة</li>'; return; }
      for(const p of low){
        const li = document.createElement('li');
        li.textContent = `${p.name} — الكمية: ${p.qty || 0}`;
        list.appendChild(li);
      }
    }

    // ----------------- Invoicing -----------------
    const currentInvoice = { items: [], customerId: null };
    function addInvoiceItem(productId, qty){
      const p = state.products.find(x=>x.id===productId);
      if(!p) return alert('منتج غير موجود');
      const line = { productId, name: p.name, qty, price: p.price || 0, total: (p.price||0)*qty };
      currentInvoice.items.push(line);
      renderInvoiceDraft();
    }
    function renderInvoiceDraft(){
      const el = document.querySelector('#invoice-draft');
      el.innerHTML='';
      let total=0;
      for(const it of currentInvoice.items){
        const li = document.createElement('div');
        li.textContent = `${it.name} — ${it.qty} × ${it.price} = ${it.total}`;
        el.appendChild(li);
        total += it.total;
      }
      document.querySelector('#invoice-total').textContent = fmt(total);
    }
    async function createInvoice(){
      if(currentInvoice.items.length===0) return alert('لا توجد عناصر بالفاتورة');
      const docRef = await addDoc(collection(db,'invoices'),{ items: currentInvoice.items, total: currentInvoice.items.reduce((s,i)=>s+i.total,0), createdAt: new Date(), createdBy: state.currentUser?.uid || null });
      // Decrease product stock
      for(const it of currentInvoice.items){
        // find product doc and update qty
        const p = state.products.find(x=>x.id===it.productId);
        if(p){
          const newQty = (p.qty||0) - it.qty;
          const prodRef = doc(db,'products',p.id);
          await updateDoc(prodRef,{qty: newQty});
        }
      }
      currentInvoice.items = [];
      await loadAllData();
      renderInvoiceDraft();
      alert('تم إنشاء الفاتورة');
    }

    // ----------------- Backup ("نسخ احتياطي") -----------------
    // Use JSZip to gather collection JSON and download a zip file
    async function backupAll(){
      const zip = new JSZip();
      const colNames = ['branches','products','warehouses','categories','customers','invoices','users'];
      for(const c of colNames){
        const snap = await getDocs(collection(db,c));
        const arr = snap.docs.map(d=>({id:d.id,...d.data()}));
        zip.file(c + '.json', JSON.stringify(arr, null, 2));
      }
      const content = await zip.generateAsync({type:'blob'});
      const url = URL.createObjectURL(content);
      const a = document.createElement('a');
      a.href = url;
      a.download = `shahrazad-backup-${new Date().toISOString()}.zip`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ----------------- Barcode scanner (Quagga) -----------------
    let scanning = false;
    async function toggleScanner(enable){
      if(enable){
        try{
          await Quagga.init({ inputStream: { type: "LiveStream", target: document.querySelector('#scanner') }, decoder: { readers: ["code_128_reader","ean_reader","ean_8_reader","upc_reader"] }});
          Quagga.onDetected(data=>{ const code = data.codeResult.code; document.querySelector('#scanned-code').textContent = code; Quagga.stop(); scanning=false; });
          Quagga.start(); scanning=true;
        } catch(e){ alert('فشل تفعيل الماسح: '+e.message); }
      } else {
        if(scanning){ Quagga.stop(); scanning=false; }
      }
    }

    // ----------------- Simple on-device "مساعد ذكي" -----------------
    // This assistant searches the cached state for answers. It's not an LLM — but it helps.
    function aiQuery(q){
      q = q.trim().toLowerCase();
      // quick heuristics
      if(q.includes('كم عدد الفروع')) return `عدد الفروع: ${state.branches.length}`;
      if(q.includes('اصناف منخفضة')){
        const low = state.products.filter(p=> (p.qty||0) <= (p.lowStockLimit||5));
        if(low.length===0) return 'لا توجد أصناف منخفضة حاليا.';
        return 'الاصناف المنخفضة: ' + low.map(x=>`${x.name}(${x.qty||0})`).join(', ');
      }
      if(q.includes('اين المخزن') || q.includes('مخازن')) return `المخازن: ${state.warehouses.map(w=>w.name).join(', ')}`;
      return 'لم أفهم السؤال تماماً — جرب سؤال عن "كم عدد الفروع" أو "اصناف منخفضة" أو "مخازن".';
    }

    // ----------------- Password change -----------------
    async function changePassword(newPass){
      if(!state.currentUser) return alert('يجب تسجيل الدخول');
      try{ await updatePassword(state.currentUser, newPass); alert('تم تغيير كلمة المرور'); } catch(e){ alert('فشل تغيير كلمة المرور: '+e.message); }
    }

    // ----------------- Init: attach event handlers once DOM loaded -----------------
    window.addEventListener('DOMContentLoaded', ()=>{
      // Login form
      document.querySelector('#login-form').addEventListener('submit', (ev)=>{ ev.preventDefault(); const em = document.querySelector('#login-email').value; const pw = document.querySelector('#login-pass').value; signIn(em,pw); });
      document.querySelector('#logout-btn').addEventListener('click', ()=>signOutUI());
      document.querySelector('#backup-btn').addEventListener('click', ()=>backupAll());
      document.querySelector('#create-invoice-btn').addEventListener('click', ()=>createInvoice());
      document.querySelector('#ai-btn').addEventListener('click', ()=>{ const q = document.querySelector('#ai-input').value; document.querySelector('#ai-output').textContent = aiQuery(q); });
      document.querySelector('#toggle-scanner').addEventListener('change',(e)=>toggleScanner(e.target.checked));

      // Simple demo: add category/product buttons (for testing)
      document.querySelector('#add-demo-category').addEventListener('click', ()=>addCategory('الكترونيات'));
      document.querySelector('#add-demo-warehouse').addEventListener('click', ()=>addWarehouse('المخزن الرئيسي'));
      document.querySelector('#add-demo-product').addEventListener('click', ()=>addProduct({name:'سلك كهربائي 2م', sku:'C-001', categoryId:null, warehouseId:null, price:35, qty:100, lowStockLimit:10}));
    });

    // Expose some functions to window for quick console usage
    window._app = { signIn, signOutUI, backupAll, addCategory, addProduct, addWarehouse, ensureVipCustomerByPhone, aiQuery, loadAllData };
  </script>

  <!-- Libraries required by the inline module (non-module globals) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{ font-family: 'Segoe UI', Tahoma, sans-serif; background:#f8fafc; color:#111; margin:0; padding:0; }
    header{ background:linear-gradient(90deg,#0ea5a0,#06b6d4); color:white; padding:20px; display:flex; align-items:center; justify-content:space-between; }
    .container{ max-width:1100px; margin:20px auto; padding:20px; background:white; border-radius:12px; box-shadow:0 6px 18px rgba(2,6,23,0.08); }
    .grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); }
    .card{ background:white; padding:14px; border-radius:10px; border:1px solid #e6eef3; }
    .hidden{ display:none; }
    button{ background:#06b6d4; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .muted{ color:#6b7280; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>نظام مبيعات — <strong>SHAHRAZAD ELECTRIC</strong></h1>
      <div class="muted">نظام رشيق، يعمل على جميع الأجهزة، مع ماسح باركود فعلي ونسخ احتياطي</div>
    </div>
    <div>
      <span id="user-email" class="muted">غير مسجل</span>
      <button id="logout-btn">تسجيل الخروج</button>
    </div>
  </header>

  <main class="container">
    <!-- Login panel -->
    <div id="login-panel">
      <h2>تسجيل الدخول</h2>
      <form id="login-form">
        <div><label>البريد الإلكتروني</label><input id="login-email" type="email" required /></div>
        <div><label>كلمة المرور</label><input id="login-pass" type="password" required /></div>
        <div><button type="submit">تسجيل دخول</button></div>
      </form>
    </div>

    <!-- App panel -->
    <div id="app-panel" class="hidden">
      <section class="grid" style="margin-bottom:16px;">
        <div class="card">
          <h3>ملخص</h3>
          <p>فروع: <strong id="branch-count">0</strong></p>
          <p>أصناف: <strong id="product-count">0</strong></p>
          <p>مخازن: <strong id="warehouse-count">0</strong></p>
          <p>عملاء: <strong id="customers-count">0</strong></p>
        </div>
        <div class="card">
          <h3>الرسوم البيانية (إحصائيات)</h3>
          <canvas id="salesChart" height="120"></canvas>
        </div>
        <div class="card">
          <h3>تنبيهات</h3>
          <ul id="low-stock-list"></ul>
        </div>
        <div class="card">
          <h3>إعدادات سريعة</h3>
          <div><label><input id="toggle-scanner" type="checkbox" /> تشغيل ماسح باركود (فعلي)</label></div>
          <div style="margin-top:8px;"><button id="backup-btn">نسخ احتياطي الآن</button></div>
        </div>
      </section>

      <section class="grid" style="margin-bottom:16px;">
        <div class="card">
          <h3>إنشاء فاتورة</h3>
          <div>
            <label>أضف عنصر تجريبي:</label>
            <button id="add-demo-product">أضف منتج تجريبي</button>
          </div>
          <div id="invoice-draft" style="margin-top:10px; min-height:60px; background:#f1f5f9; padding:8px; border-radius:8px;"></div>
          <div>المجموع: <strong id="invoice-total">0</strong></div>
          <div style="margin-top:8px;"><button id="create-invoice-btn">حفظ الفاتورة</button></div>
        </div>

        <div class="card">
          <h3>مساعد ذكي (مبسط)</h3>
          <input id="ai-input" placeholder="اسأل النظام (مثال: اصناف منخفضة)" />
          <div style="margin-top:8px;"><button id="ai-btn">اسأل</button></div>
          <div id="ai-output" style="margin-top:8px; background:#fff3cd; padding:8px; border-radius:6px;"></div>
        </div>

        <div class="card">
          <h3>ماسح باركود</h3>
          <div id="scanner" style="width:100%; height:200px; background:#000; color:white; display:flex; align-items:center; justify-content:center;">كاميرا الماسح</div>
          <div>آخر كود ممسوح: <span id="scanned-code">—</span></div>
        </div>

        <div class="card">
          <h3>أدوات سريعة (تجريبي)</h3>
          <button id="add-demo-category">أضف تصنيف</button>
          <button id="add-demo-warehouse">أضف مخزن</button>
        </div>
      </section>

      <section class="card">
        <h3>إدارة النظام والمستخدمين</h3>
        <p>تصميم شركات راقٍ ونظام تسجيل دخول متقدم — هذا ملف ابتدائي. أكواد تسجيل المستخدمين، صلاحيات الدور (Admin/Manager/Cashier) محفوظة في مجموعة <code>users</code> بداخل Firestore. أنصح بإضافة قواعد أمان Firestore مناسبة.</p>
        <p>لتغيير كلمة المرور للمستخدم الحالي (في نفس الجلسة)، افتح console: <code>_app.changePassword('newPass')</code> أو أضف واجهة مخصصة.</p>
      </section>

    </div>
  </main>

  <footer style="text-align:center; padding:12px; color:#6b7280;">
    Shahrazad Electric — نظام مبيعات ابتدائي (قابل للتطوير). الرجاء تعديل قواعد الأمان وCloud Functions قبل الانتاج.
  </footer>

</body>
</html>
