<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام المبيعات الذكي - Smart Sales Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* الألوان والمتغيرات الأساسية */
        :root {
            --primary: #2c3e50; /* كحلي داكن */
            --secondary: #3498db; /* أزرق سماوي */
            --success: #27ae60; /* أخضر */
            --warning: #f39c12; /* برتقالي */
            --danger: #e74c3c; /* أحمر */
            --light: #ecf0f1; /* رمادي فاتح جداً */
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            direction: rtl;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* الشريط الجانبي */
        .sidebar {
            width: 280px; /* زيادة قليلة للجمالية */
            background: var(--primary);
            color: white;
            transition: all 0.3s;
            padding: 20px 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .logo {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }
        
        .logo h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .menu a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--light);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background 0.2s, color 0.2s;
        }

        .menu a:hover, .menu a.active {
            background: var(--secondary);
            color: white;
        }

        .menu i {
            margin-left: 10px;
            font-size: 1.1rem;
        }

        /* المحتوى الرئيسي */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 30px;
        }

        .header h1 {
            color: var(--dark);
            font-size: 2rem;
            font-weight: 600;
        }
        
        /* لوحات الإحصائيات */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-right: 5px solid var(--secondary);
        }

        .stat-card:nth-child(2) { border-color: var(--success); }
        .stat-card:nth-child(3) { border-color: var(--warning); }
        .stat-card:nth-child(4) { border-color: var(--danger); }

        .stat-icon {
            font-size: 2.5rem;
            color: var(--secondary);
            opacity: 0.6;
        }
        
        .stat-info h3 {
            font-size: 1rem;
            color: #777;
            margin-bottom: 5px;
        }

        .stat-info p {
            font-size: 2rem;
            font-weight: 700;
        }
        
        /* جداول المنتجات والمبيعات */
        .section-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .section-card h2 {
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }

        th, td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--light);
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
        }

        tr:hover {
            background-color: #fafafa;
        }
        
        /* مساعد الدردشة الذكي */
        .chat-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }

        .chat-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--secondary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .chat-toggle:hover {
            transform: scale(1.05);
        }

        .chat-window {
            width: 380px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
            position: absolute;
            bottom: 75px;
            left: 0;
        }

        .chat-header {
            background: var(--primary);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            font-size: 1.2rem;
        }

        .chat-body {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: var(--light);
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-start;
            background-color: var(--secondary);
            color: white;
            border-bottom-right-radius: 0;
        }

        .message.bot {
            align-self: flex-end;
            background-color: white;
            color: #333;
            border: 1px solid #ddd;
            border-bottom-left-radius: 0;
            text-align: right;
        }

        .chat-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }

        .chat-input-area input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            outline: none;
            margin-left: 10px;
        }

        .chat-input-area button {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-input-area button:hover {
            background-color: #2ecc71;
        }
        
        .typing-indicator {
            align-self: flex-end;
            background-color: white;
            color: #333;
            padding: 8px 15px;
            border-radius: 15px;
            border-bottom-left-radius: 0;
            font-style: italic;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px 0;
            justify-content: center;
            border-top: 1px solid #eee;
        }

        .quick-action {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }

        .quick-action:hover {
            background-color: #2980b9;
        }

        /* Forms in Chat */
        .chat-form {
            background: #f7f7f7;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #eee;
            margin-top: 10px;
        }

        .chat-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .chat-form input, .chat-form button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }

        .chat-form button {
            background-color: var(--success);
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-form button:hover {
            background-color: #2ecc71;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .user-id-display {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 10px;
            word-break: break-all;
        }

    </style>
</head>
<body>
    <!-- شاشة التحميل -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>جاري تحميل النظام وتهيئة قاعدة البيانات...</p>
    </div>

    <div class="container" id="appContainer" style="display:none;">
        
        <!-- الشريط الجانبي (Sidebar) -->
        <div class="sidebar">
            <div class="logo">
                <h2>Smart Sales Pro</h2>
            </div>
            <nav class="menu">
                <a href="#" class="active"><i class="fas fa-chart-line"></i> لوحة التحكم</a>
                <a href="#"><i class="fas fa-boxes"></i> المخزون</a>
                <a href="#"><i class="fas fa-handshake"></i> المبيعات</a>
                <a href="#"><i class="fas fa-user-friends"></i> العملاء</a>
            </nav>
            <div class="user-id-display">
                <p>مستخدم Firestore:</p>
                <span id="currentUserId">Loading...</span>
            </div>
        </div>

        <!-- المحتوى الرئيسي (Main Content) -->
        <div class="main-content">
            <header class="header">
                <h1>لوحة التحكم الذكية</h1>
                <!-- يمكنك إضافة زر إضافي هنا مثل الإعدادات -->
                <div><a href="#" style="color: var(--primary); text-decoration: none;"><i class="fas fa-cog"></i> الإعدادات</a></div>
            </header>

            <!-- إحصائيات علوية -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>إجمالي المنتجات</h3>
                        <p id="totalProductsCount">0</p>
                    </div>
                    <i class="fas fa-box stat-icon"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>قيمة المخزون (تقريبية)</h3>
                        <p id="totalStockValue">$0</p>
                    </div>
                    <i class="fas fa-dollar-sign stat-icon" style="color: var(--success);"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>عدد الأصناف قليلة</h3>
                        <p id="lowStockCount">0</p>
                    </div>
                    <i class="fas fa-exclamation-triangle stat-icon" style="color: var(--warning);"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>إجمالي المبيعات</h3>
                        <p id="totalSalesCount">0</p>
                    </div>
                    <i class="fas fa-receipt stat-icon" style="color: var(--danger);"></i>
                </div>
            </div>

            <!-- جدول المخزون الحالي -->
            <div class="section-card">
                <h2>المخزون الحالي</h2>
                <div class="table-responsive">
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th>اسم المنتج</th>
                                <th>السعر</th>
                                <th>الكمية</th>
                                <th>الإجراء</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- سيتم تعبئتها بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>
                <p id="emptyStockMessage" style="text-align: center; margin-top: 20px; color: #999; display: none;">لا توجد منتجات في المخزون حالياً.</p>
            </div>

            <!-- جدول المبيعات (مثال) -->
            <div class="section-card">
                <h2>آخر المبيعات</h2>
                <div class="table-responsive">
                    <table id="salesTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>العميل</th>
                                <th>التاريخ</th>
                                <th>القيمة الإجمالية</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- سيتم تعبئتها بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>
                <p id="emptySalesMessage" style="text-align: center; margin-top: 20px; color: #999; display: none;">لا توجد سجلات مبيعات حالياً.</p>
            </div>

        </div>
        
        <!-- مساعد الدردشة (Chat Widget) -->
        <div class="chat-container">
            <div id="chatToggle" class="chat-toggle">
                <i class="fas fa-robot"></i>
            </div>

            <div id="chatWindow" class="chat-window">
                <div class="chat-header">
                    <h3>المساعد الذكي (المدير)</h3>
                    <!-- لاغلاق النافذة -->
                    <span id="chatClose" style="cursor: pointer;"><i class="fas fa-times"></i></span>
                </div>
                
                <div id="chatBody" class="chat-body">
                    <div class="message bot">
                        مرحباً بك! أنا مساعدك الذكي. يمكنك التحكم في المخزون والمبيعات بالدردشة. جرب أحد الأوامر السريعة:
                    </div>
                    <!-- سيتم إضافة الرسائل هنا -->
                </div>

                <div class="quick-actions">
                    <button class="quick-action" data-action="add-product">ضيف منتج</button>
                    <button class="quick-action" data-action="view-stock">شوف المخزن</button>
                    <button class="quick-action" data-action="low-stock">وش قرب يخلص</button>
                    <button class="quick-action" data-action="total-sales">كم إجمالي المبيعات</button>
                </div>
                
                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="اكتب أمرك هنا...">
                    <button id="sendMessage"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- تحميل Firebase SDKs (مطلوب ليعمل الكود) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // **********************************************
        // 1. إعدادات FIREBASE (من الكود الذي قدمته)
        // **********************************************

        const firebaseConfig = {
            apiKey: "AIzaSyACLchq_aV7AT4wqznXIOv395Nbkeemc_c",
            authDomain: "ai-sales-a92b9.firebaseapp.com",
            projectId: "ai-sales-a92b9",
            storageBucket: "ai-sales-a92b9.firebasestorage.app",
            messagingSenderId: "100700395015",
            appId: "1:100700395015:web:79760bc1425b693d3a3ca2",
            measurementId: "G-KN8CS68W7Q"
        };
        
        // متغيرات Firebase العمومية
        let app, db, auth, userId, isAuthReady = false;
        
        // تهيئة Firebase
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // تهيئة الـ Analytics (اختياري)
            // const analytics = getAnalytics(app); 
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            document.getElementById('loadingOverlay').innerHTML = `<p style="color: var(--danger);">خطأ في تهيئة Firebase. تحقق من إعداداتك.</p>`;
            return;
        }

        // **********************************************
        // 2. إدارة التوثيق (Authentication)
        // **********************************************

        // دالة لتسجيل الدخول
        async function authenticateUser() {
            try {
                // استخدام الرموز العمومية المقدمة من البيئة إذا وجدت
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                // للحفاظ على جلسة المستخدم
                await setPersistence(auth, browserLocalPersistence);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // إخفاء شاشة التحميل وعرض التطبيق بمجرد تسجيل الدخول
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
                
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                document.getElementById('loadingOverlay').innerHTML = `<p style="color: var(--danger);">فشل التوثيق: ${error.message}</p>`;
            }
        }

        // مراقب حالة التوثيق
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('currentUserId').textContent = userId;
                isAuthReady = true;
                console.log("User authenticated with UID:", userId);
                
                // بدء مراقبة البيانات بعد التوثيق
                setupDataListeners();
            } else {
                console.log("No user signed in. Attempting sign-in...");
                authenticateUser();
            }
        });

        // **********************************************
        // 3. مسارات Firestore (PATHS)
        // **********************************************

        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-sales-app';
        
        // مسار خاص بالمخزون (Private Collection for the user)
        const getProductsCollection = () => {
            if (!userId) throw new Error("User ID is not defined.");
            // المسار: /artifacts/{appId}/users/{userId}/products
            return collection(db, 'artifacts', APP_ID, 'users', userId, 'products');
        };

        // مسار خاص بالمبيعات (Private Collection for the user)
        const getSalesCollection = () => {
            if (!userId) throw new Error("User ID is not defined.");
            // المسار: /artifacts/{appId}/users/{userId}/sales
            return collection(db, 'artifacts', APP_ID, 'users', userId, 'sales');
        };

        // **********************************************
        // 4. الدوال الأساسية لإدارة البيانات (CRUD)
        // **********************************************

        let productsCache = [];
        let salesCache = [];
        const LOW_STOCK_THRESHOLD = 5;

        // دالة لإضافة منتج جديد عبر الدردشة
        async function addProductToFirestore(name, price, quantity) {
            if (!isAuthReady) return "النظام غير جاهز بعد، الرجاء الانتظار قليلاً.";

            try {
                const newProduct = {
                    name: name.trim(),
                    price: parseFloat(price) || 0,
                    quantity: parseInt(quantity) || 0,
                    createdAt: serverTimestamp()
                };

                await addDoc(getProductsCollection(), newProduct);
                return `تم إضافة المنتج **${newProduct.name}** بكمية ${newProduct.quantity} وسعر ${newProduct.price.toFixed(2)} بنجاح!`;

            } catch (error) {
                console.error("Error adding product:", error);
                return `عذراً، حدث خطأ أثناء إضافة المنتج: ${error.message}`;
            }
        }

        // دالة لعرض جدول المنتجات (تُشغّل عند تحديث البيانات)
        function updateProductsTable() {
            const tableBody = document.getElementById('productsTable').querySelector('tbody');
            tableBody.innerHTML = '';
            
            if (productsCache.length === 0) {
                document.getElementById('emptyStockMessage').style.display = 'block';
                return;
            } else {
                document.getElementById('emptyStockMessage').style.display = 'none';
            }

            let totalValue = 0;
            let lowStockCount = 0;
            
            productsCache.forEach(product => {
                const row = tableBody.insertRow();
                row.className = product.quantity <= LOW_STOCK_THRESHOLD ? 'bg-yellow-100' : ''; // للتنبيه المرئي
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>$${product.price.toFixed(2)}</td>
                    <td>${product.quantity}</td>
                    <td>
                        <button onclick="deleteProduct('${product.id}')" style="background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">حذف</button>
                    </td>
                `;
                totalValue += product.price * product.quantity;
                if (product.quantity <= LOW_STOCK_THRESHOLD) {
                    lowStockCount++;
                }
            });

            // تحديث الإحصائيات
            document.getElementById('totalProductsCount').textContent = productsCache.length;
            document.getElementById('totalStockValue').textContent = `$${totalValue.toFixed(2)}`;
            document.getElementById('lowStockCount').textContent = lowStockCount;
        }

        // دالة لعرض جدول المبيعات (تُشغّل عند تحديث البيانات)
        function updateSalesTable() {
            const tableBody = document.getElementById('salesTable').querySelector('tbody');
            tableBody.innerHTML = '';

            if (salesCache.length === 0) {
                document.getElementById('emptySalesMessage').style.display = 'block';
                return;
            } else {
                document.getElementById('emptySalesMessage').style.display = 'none';
            }
            
            let totalSales = 0;

            salesCache.forEach(sale => {
                const row = tableBody.insertRow();
                const date = sale.createdAt ? new Date(sale.createdAt.seconds * 1000).toLocaleDateString('ar-SA') : 'اليوم';

                row.innerHTML = `
                    <td>#${sale.id.substring(0, 6)}</td>
                    <td>${sale.customerName || 'عميل نقدي'}</td>
                    <td>${date}</td>
                    <td>$${sale.totalAmount.toFixed(2)}</td>
                `;
                totalSales += sale.totalAmount;
            });
            
            // تحديث الإحصائيات
            document.getElementById('totalSalesCount').textContent = salesCache.length;
            // يمكنك إضافة إجمالي قيمة المبيعات إلى مكان ما إذا أردت
        }
        
        // دالة مراقبة البيانات في الوقت الفعلي
        function setupDataListeners() {
            if (!isAuthReady) return;

            // مراقبة المخزون (Products)
            onSnapshot(getProductsCollection(), (snapshot) => {
                productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateProductsTable();
                console.log("Products updated from Firestore.");
            }, (error) => {
                console.error("Error listening to products:", error);
            });

            // مراقبة المبيعات (Sales)
            onSnapshot(query(getSalesCollection(), orderBy("createdAt", "desc"), limit(10)), (snapshot) => {
                salesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateSalesTable();
                console.log("Sales updated from Firestore.");
            }, (error) => {
                console.error("Error listening to sales:", error);
            });
        }
        
        // **********************************************
        // 5. وظائف المساعد الذكي والتحليل (CHATBOT)
        // **********************************************

        const chatBody = document.getElementById('chatBody');
        const chatInput = document.getElementById('chatInput');
        const sendMessageButton = document.getElementById('sendMessage');
        
        // دالة لإضافة رسالة إلى نافذة الدردشة
        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            messageDiv.innerHTML = text; // استخدام innerHTML للسماح بالـ HTML داخل الرسالة (مثل النموذج)
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight; // التمرير للأسفل
        }

        // دالة لإظهار مؤشر الكتابة للروبوت
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.textContent = 'المساعد يكتب...';
            chatBody.appendChild(indicator);
            chatBody.scrollTop = chatBody.scrollHeight;
            return indicator;
        }

        // دالة عرض نموذج إضافة منتج داخل الدردشة
        function showProductForm() {
            return `
                <div class="chat-form">
                    <form id="productForm">
                        <label for="pName">اسم المنتج:</label>
                        <input type="text" id="pName" required placeholder="مثال: شاحن سريع">
                        <label for="pPrice">السعر ($):</label>
                        <input type="number" id="pPrice" required min="0.01" step="0.01" placeholder="مثال: 25.00">
                        <label for="pQuantity">الكمية:</label>
                        <input type="number" id="pQuantity" required min="1" placeholder="مثال: 50">
                        <button type="submit">إضافة المنتج</button>
                    </form>
                </div>
            `;
        }
        
        // دالة تحليل الأوامر وفهم اللهجات (NLP-Lite with Regex)
        async function processQuestion(question) {
            const q = question.toLowerCase().trim();

            if (q.includes("ضيف منتج") || q.includes("اضافة صنف") || q.includes("زود المخزون")) {
                return `حسناً، لإضافة منتج جديد يرجى ملء النموذج التالي: ${showProductForm()}`;
            }

            if (q.includes("شوف المخزن") || q.includes("جرد") || q.includes("المخزون الحالي")) {
                let stockList = productsCache.map(p => ` - ${p.name}: ${p.quantity} حبة`).join('<br>');
                if (productsCache.length === 0) {
                     stockList = "المخزون فارغ حالياً.";
                }
                return `**قائمة المخزون (${productsCache.length} صنف):**<br>${stockList}`;
            }
            
            if (q.includes("وش قرب يخلص") || q.includes("قليل") || q.includes("نقص")) {
                const lowStock = productsCache.filter(p => p.quantity <= LOW_STOCK_THRESHOLD);
                let lowStockList = lowStock.map(p => ` - ${p.name} (باقي ${p.quantity} حبة)`).join('<br>');

                if (lowStock.length === 0) {
                    lowStockList = "كل شيء تمام! لا يوجد أصناف قربت تخلص.";
                }
                return `**الأصناف التي تحتاج متابعة (${lowStock.length}):**<br>${lowStockList}`;
            }
            
            if (q.includes("كم إجمالي المبيعات") || q.includes("إيراداتنا")) {
                const totalSalesAmount = salesCache.reduce((sum, sale) => sum + sale.totalAmount, 0);
                return `إجمالي عدد المبيعات المسجلة هو **${salesCache.length}** عملية. وإجمالي قيمة هذه المبيعات هي **$${totalSalesAmount.toFixed(2)}**.`;
            }

            if (q.includes("سوي فاتورة") || q.includes("بيع منتج")) {
                // محاكاة عملية البيع
                const productName = "شاحن لاسلكي";
                const product = productsCache.find(p => p.name.includes("شاحن")); // بحث بسيط

                if (product && product.quantity > 0) {
                    // إضافة عملية بيع (لتظهر في جدول المبيعات)
                    const newSale = {
                        customerName: "عميل الدردشة",
                        totalAmount: product.price,
                        items: [{ name: product.name, quantity: 1, price: product.price }],
                        createdAt: serverTimestamp()
                    };
                    await addDoc(getSalesCollection(), newSale);

                    // تحديث كمية المخزون (عملية معقدة تحتاج لـ Transaction في الواقع)
                    // هنا سنقوم بمحاكاة تحديث الكمية (في الواقع يجب استخدام runTransaction)
                    const productRef = doc(db, getProductsCollection().path, product.id);
                    await updateDoc(productRef, {
                        quantity: product.quantity - 1
                    });

                    return `**تمت عملية بيع سريعة بنجاح!** تم بيع 1 قطعة من **${product.name}** بقيمة $${product.price.toFixed(2)}. تم تحديث المخزون آلياً.`;
                } else {
                    return `عفواً، لا أستطيع إجراء عملية بيع حالياً. جرب إضافة منتجات أولاً (مثل شاحن لاسلكي) عبر أمر 'ضيف منتج'.`;
                }
            }
            
            return "عذراً، لم أفهم طلبك تحديداً. أنا أفهم فقط أوامر إدارة المخزون والمبيعات الأساسية مثل 'ضيف منتج' أو 'شوف المخزن'.";
        }
        
        // **********************************************
        // 6. أحداث الواجهة الأمامية (Event Listeners)
        // **********************************************

        // فتح وإغلاق نافذة الدردشة
        document.getElementById('chatToggle').addEventListener('click', () => {
            document.getElementById('chatWindow').style.display = 'flex';
        });
        document.getElementById('chatClose').addEventListener('click', () => {
            document.getElementById('chatWindow').style.display = 'none';
        });
        
        // الإجراءات السريعة
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('quick-action')) {
                const action = e.target.dataset.action;
                let question = '';
                
                switch(action) {
                    case 'add-product': question = 'ضيف منتج جديد'; break;
                    case 'view-stock': question = 'شوف المخزن'; break;
                    case 'low-stock': question = 'وش قرب يخلص'; break;
                    case 'total-sales': question = 'كم إجمالي المبيعات'; break;
                }
                
                if (question) {
                    handleUserMessage(question);
                }
            }
        });

        // دالة موحدة لمعالجة رسالة المستخدم (إرسال وزر)
        async function handleUserMessage(question) {
            if (!question.trim()) return;

            addMessage(question, true);
            chatInput.value = ''; // مسح الإدخال
            
            const typingIndicator = showTypingIndicator();
            
            const answer = await processQuestion(question);
            
            typingIndicator.remove();
            addMessage(answer);
        }

        // إرسال بالزر أو بالإنتر
        sendMessageButton.addEventListener('click', () => {
            const question = chatInput.value;
            handleUserMessage(question);
        });
        
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageButton.click();
            }
        });

        // التعامل مع نموذج إضافة المنتج داخل الدردشة (بعد حقنه في DOM)
        document.addEventListener('submit', async (e) => {
            if (e.target && e.target.id === 'productForm') {
                e.preventDefault();
                
                const name = document.getElementById('pName').value;
                const price = document.getElementById('pPrice').value;
                const quantity = document.getElementById('pQuantity').value;
                
                if (!name || !price || !quantity) {
                    addMessage("الرجاء ملء جميع حقول النموذج.", false);
                    return;
                }

                // إظهار مؤشر الكتابة أثناء الإضافة لقاعدة البيانات
                const typingIndicator = showTypingIndicator();
                
                const result = await addProductToFirestore(name, price, quantity);
                
                typingIndicator.remove();
                addMessage(result, false);

                // إزالة النموذج بعد الإضافة الناجحة
                e.target.closest('.chat-form').remove(); 
            }
        });

        // إضافة دالة الحذف (لتكون قابلة للوصول من HTML)
        window.deleteProduct = async (productId) => {
            if (confirm("هل أنت متأكد من حذف هذا المنتج؟")) {
                 try {
                    await deleteDoc(doc(getProductsCollection(), productId));
                    // لا نحتاج لتحديث الجدول يدوياً، onSnapshot سيتولى الأمر
                    addMessage(`تم حذف المنتج ذو المعرف ${productId.substring(0, 6)} بنجاح.`, false);
                } catch (error) {
                    console.error("Error deleting product:", error);
                    addMessage(`عذراً، حدث خطأ أثناء الحذف: ${error.message}`, false);
                }
            }
        };

        // **********************************************
        // 7. التهيئة الأولية (التوثيق يبدأ كل شيء)
        // **********************************************
        // ملاحظة: لا حاجة لاستدعاء authenticateUser() يدوياً، onAuthStateChanged ستبدأ العملية.

    </script>
</body>
</html>
